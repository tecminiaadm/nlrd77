<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel | Adm</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>
    
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="date=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    
    <style>
        :root {
            --primary-color: #212121;
            --secondary-color: #424242;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --info-color: #2196F3;
            --light-bg: #f5f5f5;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #212121;
            --text-secondary: #757575;
            --shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; }
        html, body { height: 100%; overflow: hidden; background: var(--light-bg); color: var(--text-primary); }
        body { font-size: 14px; padding: 0; display: flex; flex-direction: column; }
        .admin-header, .stats-grid, .stat-card, .tab-navigation, .tab-btn, .list-item, .item-header, .item-title, .item-subtitle, .status-badge, .settings-section, .section-title, .form-input[readonly], .form-input:not(input):not(textarea), .modal-title, .empty-state, .empty-title, .empty-text, .loading-text, .notification { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        input, textarea { -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text; }
        .status-bar { height: env(safe-area-inset-top, 0px); background: var(--primary-color); }
        .admin-container { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
        .admin-header { background: var(--primary-color); color: white; padding: 12px 16px; box-shadow: var(--shadow); z-index: 100; flex-shrink: 0; }
        .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .header-title { display: flex; align-items: center; gap: 10px; }
        .header-icon { width: 36px; height: 36px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .header-text h1 { font-size: 1.2rem; font-weight: 600; }
        .header-text p { font-size: 0.75rem; opacity: 0.8; }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { width: 36px; height: 36px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .icon-btn:hover { background: rgba(255, 255, 255, 0.15); }
        
        /* Novo estilo para o botão de refresh minimalista */
        .refresh-btn-minimal {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        .refresh-btn-minimal:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: rotate(90deg);
        }
        .refresh-btn-minimal:active {
            transform: rotate(180deg);
        }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 12px 16px; background: white; flex-shrink: 0; }
        .stat-card { background: var(--card-bg); border-radius: 12px; padding: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .stat-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .stat-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .stat-icon.total { background: rgba(33, 150, 243, 0.1); color: var(--info-color); }
        .stat-icon.active { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .stat-icon.pending { background: rgba(255, 152, 0, 0.1); color: var(--warning-color); }
        .stat-icon.blocked { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .stat-icon.expired { background: rgba(96, 125, 139, 0.1); color: #607d8b; }
        .stat-icon.revenue { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
        .stat-icon.free-trial { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
        .stat-number { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }
        .tab-navigation { display: flex; background: white; border-bottom: 1px solid var(--border-color); flex-shrink: 0; padding: 0 16px; }
        .tab-btn { flex: 1; padding: 14px 0; background: none; border: none; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; cursor: pointer; position: relative; transition: all 0.2s ease; }
        .tab-btn.active { color: var(--primary-color); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--primary-color); border-radius: 3px 3px 0 0; }
        .main-content { flex: 1; overflow: hidden; position: relative; }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 16px; display: none; background: var(--light-bg); }
        .tab-content.active { display: block; }
        .search-bar { margin-bottom: 16px; }
        .search-container { background: white; border-radius: 10px; padding: 0 12px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .search-container i { color: var(--text-secondary); font-size: 0.9rem; }
        .search-container input { flex: 1; padding: 12px 0; border: none; outline: none; font-size: 0.9rem; background: transparent; }
        .list-container { display: flex; flex-direction: column; gap: 10px; }
        .list-item { background: white; border-radius: 12px; padding: 16px; box-shadow: var(--shadow); border: 1px solid var(--border-color); transition: all 0.2s ease; cursor: pointer; }
        .list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .item-title { font-weight: 600; font-size: 1rem; color: var(--text-primary); margin-bottom: 4px; }
        .item-subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 2px; }
        .item-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
        .detail-item { display: flex; flex-direction: column; gap: 4px; }
        .detail-label { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }
        .detail-value { font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; text-align: center; }
        .status-active, .status-approved { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .status-pending { background: rgba(255, 152, 0, 0.1); color: var(--warning-color); }
        .status-blocked, .status-rejected { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .status-expired { background: rgba(96, 125, 139, 0.1); color: #607d8b; }
        .status-renewal-pending { background: rgba(33, 150, 243, 0.1); color: var(--info-color); }
        .status-free-trial { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
        .action-buttons { display: flex; justify-content: center; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); }
        .action-btn { padding: 8px 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 6px; min-width: 100px; }
        .btn-view { background: rgba(33, 150, 243, 0.1); color: var(--info-color); }
        .btn-activate, .btn-approve { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .btn-block, .btn-reject { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .btn-delete { background: rgba(33, 33, 33, 0.1); color: var(--primary-color); }
        .btn-whatsapp { background: rgba(37, 211, 102, 0.1); color: #25D366; }
        .btn-finish { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .btn-send-msg { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .settings-section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .section-title { font-size: 1rem; font-weight: 600; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--primary-color); color: var(--text-primary); }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary); font-size: 0.85rem; }
        .form-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; transition: all 0.2s ease; background: white; color: var(--text-primary); }
        .form-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(33, 33, 33, 0.1); }
        .form-textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; resize: vertical; min-height: 100px; font-family: inherit; }
        .form-hint { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; display: block; }
        .submit-btn { width: 100%; padding: 14px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .submit-btn:hover { background: #000; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-icon { font-size: 3rem; margin-bottom: 16px; color: #e0e0e0; }
        .empty-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
        .empty-text { font-size: 0.9rem; line-height: 1.4; }
        
        .icon-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        .icon-action-btn:hover {
            background: var(--light-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .icon-action-btn.approve:hover { color: var(--success-color); border-color: var(--success-color); }
        .icon-action-btn.reject:hover { color: var(--danger-color); border-color: var(--danger-color); }
        .icon-action-btn.message:hover { color: #9c27b0; border-color: #9c27b0; }
        .icon-action-btn.whatsapp:hover { color: #25D366; border-color: #25D366; }
        .icon-action-btn.delete:hover { color: var(--danger-color); border-color: var(--danger-color); }
        .icon-action-btn.view:hover { color: var(--info-color); border-color: var(--info-color); }
        .icon-action-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }
        
        .image-viewer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 10000; display: none; justify-content: center; align-items: center; touch-action: pan-x pan-y; -webkit-user-select: none; user-select: none; }
        .image-viewer-container { position: relative; width: 100%; height: 100%; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .image-viewer-img { max-width: 100%; max-height: 100%; object-fit: contain; transform-origin: 0 0; transition: transform 0.1s ease-out; cursor: grab; touch-action: pan-x pan-y; }
        .image-viewer-img:active { cursor: grabbing; }
        .image-viewer-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10001; }
        .image-viewer-btn { width: 44px; height: 44px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s ease; }
        .image-viewer-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .image-viewer-zoom-info { position: absolute; bottom: 20px; left: 20px; color: white; background: rgba(0, 0, 0, 0.5); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; backdrop-filter: blur(10px); }
        .receipt-preview-container { position: relative; width: 100%; height: 300px; border-radius: 12px; overflow: hidden; background: #f8f9fa; margin-bottom: 16px; border: 2px solid var(--border-color); touch-action: pan-x pan-y; }
        .receipt-preview-img { width: 100%; height: 100%; object-fit: contain; cursor: pointer; transition: transform 0.2s ease; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 16px; animation: fadeIn 0.3s ease; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease; }
        .modal-header { padding: 20px 20px 12px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; padding: 4px; line-height: 1; }
        .modal-body { padding: 20px; }
        .confirmation-text { padding: 12px; border: 2px solid var(--danger-color); border-radius: 8px; background: rgba(244, 67, 54, 0.05); margin-bottom: 20px; font-size: 0.9rem; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 3000; display: none; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
        .loading-text { color: white; font-weight: 500; font-size: 0.9rem; }
        .notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 16px 24px; border-radius: 12px; background: var(--primary-color); color: white; font-weight: 500; text-align: center; z-index: 4000; animation: fadeIn 0.3s ease; max-width: 280px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .notification.success { background: var(--success-color); }
        .notification.error { background: var(--danger-color); }
        .notification.info { background: var(--info-color); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .mt-1 { margin-top: 8px; } .mt-2 { margin-top: 16px; } .mb-1 { margin-bottom: 8px; } .mb-2 { margin-bottom: 16px; } .text-center { text-align: center; } .flex { display: flex; } .items-center { align-items: center; } .justify-between { justify-content: space-between; } .gap-2 { gap: 8px; }
        @media (max-width: 360px) { 
            .stats-grid { grid-template-columns: 1fr; } 
            .action-buttons { flex-wrap: wrap; } 
            .action-btn { min-width: 80px; font-size: 0.75rem; padding: 6px 8px; } 
            .tab-btn { font-size: 0.8rem; padding: 12px 0; }
        }
    </style>
</head>
<body>
    <div class="status-bar"></div>
    
    <div class="image-viewer-overlay" id="imageViewer">
        <div class="image-viewer-container">
            <img class="image-viewer-img" id="imageViewerImg" alt="Comprovante">
            <div class="image-viewer-controls">
                <button class="image-viewer-btn" id="imageViewerZoomIn"><i class="fas fa-search-plus"></i></button>
                <button class="image-viewer-btn" id="imageViewerZoomOut"><i class="fas fa-search-minus"></i></button>
                <button class="image-viewer-btn" id="imageViewerReset"><i class="fas fa-sync-alt"></i></button>
                <button class="image-viewer-btn" id="imageViewerClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="image-viewer-zoom-info" id="imageViewerZoomInfo">100%</div>
        </div>
    </div>
    
    <div class="admin-container">
        <header class="admin-header">
            <div class="header-top">
                <div class="header-title">
                    <div class="header-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="header-text">
                        <h1>Admin Venda+</h1>
                        <p>Painel de Controle</p>
                    </div>
                </div>
                <div class="header-actions">
                    <!-- Botão de refresh minimalista adicionado no cabeçalho -->
                    <button class="refresh-btn-minimal" id="refreshBtnMinimal" title="Atualizar dados">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Dashboard como conteúdo da primeira aba -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="dashboard"><i class="fas fa-chart-bar"></i> Dashboard</button>
            <button class="tab-btn" data-tab="users"><i class="fas fa-users"></i> User</button>
            <button class="tab-btn" data-tab="payments"><i class="fas fa-money-bill"></i> Pagamentos</button>
            <button class="tab-btn" data-tab="settings"><i class="fas fa-cog"></i> Ajustes</button>
        </div>
        
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="stats-grid" id="statsGrid"></div>
                <div class="settings-section">
                    <h2 class="section-title">Resumo do Sistema</h2>
                    <div class="form-group">
                        <label class="form-label">Admin Logado</label>
                        <div class="form-input" style="background: #f8f9fa;">
                            <div id="adminInfo"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Última Atualização</label>
                        <div class="form-input" style="background: #f8f9fa;">
                            <div id="lastUpdate">Carregando...</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status do Sistema</label>
                        <div class="form-input" style="background: #f8f9fa; color: var(--success-color); font-weight: 600;">
                            <i class="fas fa-check-circle"></i> Online e Funcionando
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <div class="search-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchUsers" placeholder="Buscar usuários...">
                    </div>
                </div>
                <div class="list-container" id="usersList"></div>
                <div class="empty-state" id="usersEmpty" style="display: none;">
                    <div class="empty-icon"><i class="fas fa-users-slash"></i></div>
                    <div class="empty-title">Nenhum usuário encontrado</div>
                    <div class="empty-text">Os usuários cadastrados aparecerão aqui</div>
                </div>
            </div>
            
            <!-- Payments Tab -->
            <div id="paymentsTab" class="tab-content">
                <div class="search-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchPayments" placeholder="Buscar pagamentos...">
                    </div>
                </div>
                <div class="list-container" id="paymentsList"></div>
                <div class="empty-state" id="paymentsEmpty" style="display: none;">
                    <div class="empty-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="empty-title">Nenhum pagamento encontrado</div>
                    <div class="empty-text">Os pagamentos aparecerão aqui</div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="settings-section">
                    <h2 class="section-title">Ajustes de Pagamento</h2>
                    <form id="paymentSettingsForm">
                        <div class="form-group">
                            <label class="form-label">Chave PIX Padrão</label>
                            <input type="text" id="pixKey" class="form-input" placeholder="Chave PIX para recebimentos" required>
                            <span class="form-hint">Esta chave PIX será exibida para todos os usuários</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp para Notificações</label>
                            <input type="text" id="adminWhatsApp" class="form-input" placeholder="(11) 99999-9999" required>
                            <span class="form-hint">Número que receberá notificações de novos pagamentos</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor do Plano Mensal (R$)</label>
                            <input type="number" id="monthlyPlanPrice" class="form-input" step="0.01" min="0" value="99.00" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dias para Notificação de Vencimento</label>
                            <input type="number" id="expirationWarningDays" class="form-input" min="1" max="30" value="7" required>
                            <span class="form-hint">Dias antes do vencimento para notificar o usuário</span>
                        </div>
                        <button type="submit" class="submit-btn"><i class="fas fa-save"></i> Salvar Ajustes</button>
                    </form>
                </div>
                
                <div class="settings-section">
                    <h2 class="section-title">Redefinir Senha</h2>
                    <div class="form-group">
                        <label class="form-label">Redefinir Senha via E-mail</label>
                            <div class="form-input" style="background: #f8f9fa; padding: 16px;">
                            <p style="margin-bottom: 12px; color: var(--text-secondary);">Clique no botão abaixo para enviar um link de redefinição de senha para o e-mail cadastrado.</p>
                            <button type="button" class="submit-btn" id="sendResetPasswordBtn" style="background: var(--info-color);">
                                <i class="fas fa-envelope"></i> Enviar Link de Redefinição
                            </button>
                        </div>
                        <span class="form-hint">Um link será enviado para o e-mail do administrador atual</span>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h2 class="section-title">Sessão</h2>
                    <div class="form-group">
                        <label class="form-label">Encerrar Sessão</label>
                        <div class="form-input" style="background: #f8f9fa; padding: 16px;">
                            <p style="margin-bottom: 12px; color: var(--text-secondary);">Esta ação desconectará você completamente do painel administrativo. Você será redirecionado para a página de login.</p>
                            <button type="button" class="submit-btn" id="logoutBtn" style="background: var(--danger-color);">
                                <i class="fas fa-sign-out-alt"></i> Fazer Logoff
                            </button>
                        </div>
                        <span class="form-hint">Encerra completamente sua sessão atual</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RODAPÉ REMOVIDO -->
    </div>
    
    <div class="modal" id="userDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Usuário</h2>
                <button class="modal-close" id="closeUserModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="userDetailsContent"></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="paymentDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Pagamento</h2>
                <button class="modal-close" id="closePaymentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="paymentDetailsContent"></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="deleteConfirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Confirmar Exclusão</h2>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este pagamento?</p>
                <div class="confirmation-text">
                    <strong>Digite "CONFIRMAR" para excluir:</strong>
                    <input type="text" id="confirmationInput" class="form-input mt-1" placeholder="Digite CONFIRMAR">
                </div>
                <div class="flex gap-2 mt-2">
                    <button type="button" class="submit-btn" style="background: #757575;" id="cancelDeleteBtn">Cancelar</button>
                    <button type="button" class="submit-btn" style="background: var(--danger-color);" id="confirmDeleteBtn" disabled><i class="fas fa-trash"></i> Excluir</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <script>
        // Cache de referências DOM e otimizações
        const firebaseConfig = {
            apiKey: "AIzaSyB7U-JfKAlkPxSyL4AEf5u0BgcDzSXf41M",
            authDomain: "appvendas-1eebf.firebaseapp.com",
            projectId: "appvendas-1eebf",
            storageBucket: "appvendas-1eebf.firebasestorage.app",
            messagingSenderId: "229472373918",
            appId: "1:229472373918:web:39cd4940b052b2375f3f8f"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Cache de funções frequentemente usadas
        const now = () => new Date().toISOString();
        const $ = document.getElementById.bind(document);
        const $$ = document.querySelectorAll.bind(document);
        const createElement = document.createElement.bind(document);
        
        // Variáveis de estado
        let adminUser = null;
        let users = [];
        let payments = [];
        let systemConfig = {};
        let currentPaymentToDelete = null;
        let lastUpdateTime = null;
        
        // Image viewer state
        let imageViewerScale = 1;
        let imageViewerTranslateX = 0;
        let imageViewerTranslateY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let imageViewerRect = null;

        // Cache de referências DOM
        const refreshBtnMinimal = $('refreshBtnMinimal');
        const tabBtns = $$('.tab-btn');
        const tabContents = $$('.tab-content');
        const statsGrid = $('statsGrid');
        const usersList = $('usersList');
        const usersEmpty = $('usersEmpty');
        const paymentsList = $('paymentsList');
        const paymentsEmpty = $('paymentsEmpty');
        const searchUsers = $('searchUsers');
        const searchPayments = $('searchPayments');
        const adminInfo = $('adminInfo');
        const lastUpdate = $('lastUpdate');
        const logoutBtn = $('logoutBtn');
        const sendResetPasswordBtn = $('sendResetPasswordBtn');
        
        const imageViewer = $('imageViewer');
        const imageViewerImg = $('imageViewerImg');
        const imageViewerZoomIn = $('imageViewerZoomIn');
        const imageViewerZoomOut = $('imageViewerZoomOut');
        const imageViewerReset = $('imageViewerReset');
        const imageViewerClose = $('imageViewerClose');
        const imageViewerZoomInfo = $('imageViewerZoomInfo');
        
        const paymentSettingsForm = $('paymentSettingsForm');
        const pixKeyInput = $('pixKey');
        const adminWhatsAppInput = $('adminWhatsApp');
        const monthlyPlanPriceInput = $('monthlyPlanPrice');
        const expirationWarningDaysInput = $('expirationWarningDays');
        
        const userDetailsModal = $('userDetailsModal');
        const closeUserModal = $('closeUserModal');
        const paymentDetailsModal = $('paymentDetailsModal');
        const closePaymentModal = $('closePaymentModal');
        const deleteConfirmationModal = $('deleteConfirmationModal');
        const closeDeleteModal = $('closeDeleteModal');
        const cancelDeleteBtn = $('cancelDeleteBtn');
        const confirmDeleteBtn = $('confirmDeleteBtn');
        const confirmationInput = $('confirmationInput');
        
        const loadingOverlay = $('loadingOverlay');

        // Constantes reutilizáveis
        const STATUS_TEXTS = {
            active: 'Ativo',
            pending: 'Pendente',
            blocked: 'Bloqueado',
            expired: 'Expirado',
            renewal_pending: 'Renovação Pendente'
        };

        const STATUS_CLASSES = {
            active: 'status-active',
            pending: 'status-pending',
            blocked: 'status-blocked',
            expired: 'status-expired',
            renewal_pending: 'status-renewal-pending'
        };

        const PAYMENT_STATUS_TEXTS = {
            pending: 'Pendente',
            pending_approval: 'Aguardando Aprovação',
            approved: 'Aprovado',
            rejected: 'Rejeitado'
        };

        const PAYMENT_STATUS_CLASSES = {
            pending: 'status-pending',
            pending_approval: 'status-pending',
            approved: 'status-approved',
            rejected: 'status-rejected'
        };

        // Cache de templates e strings HTML
        const templates = {
            statCard: (stat) => `
                <div class="stat-card">
                    <div class="stat-row">
                        <div class="stat-icon ${stat.color}"><i class="fas fa-${stat.icon}"></i></div>
                        <div class="stat-number">${stat.value}</div>
                    </div>
                    <div class="stat-label">${stat.label}</div>
                </div>`,
            
            emptyState: (icon, title, text) => `
                <div class="empty-state">
                    <div class="empty-icon"><i class="fas fa-${icon}"></i></div>
                    <div class="empty-title">${title}</div>
                    <div class="empty-text">${text}</div>
                </div>`
        };

        async function init() {
            await checkAdminAuth();
            await Promise.all([
                loadSystemConfig(),
                loadAllUsers(),
                loadAllPayments()
            ]);
            setupEventListeners();
            setupImageViewer();
            updateStats();
            updateAdminInfo();
            updateLastUpdateTime();
        }

        function setupImageViewer() {
            // Event listeners otimizados
            const zoom = (factor) => zoomImageViewer(factor);
            imageViewerZoomIn.addEventListener('click', () => zoom(1.2));
            imageViewerZoomOut.addEventListener('click', () => zoom(0.8));
            imageViewerReset.addEventListener('click', resetImageViewer);
            imageViewerClose.addEventListener('click', () => imageViewer.style.display = 'none');
            
            // Wheel event otimizado
            imageViewerImg.addEventListener('wheel', (e) => {
                e.preventDefault();
                zoomImageViewer(e.deltaY > 0 ? 0.8 : 1.2, e.clientX, e.clientY);
            }, { passive: false });
            
            // Touch events otimizados
            imageViewerImg.addEventListener('touchstart', handleTouchStart, { passive: false });
            imageViewerImg.addEventListener('touchmove', handleTouchMove, { passive: false });
            imageViewerImg.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            // Mouse events
            imageViewerImg.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
            
            imageViewerImg.addEventListener('dblclick', resetImageViewer);
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                startDrag({
                    clientX: e.touches[0].clientX,
                    clientY: e.touches[0].clientY
                });
            }
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                doDrag({
                    clientX: e.touches[0].clientX,
                    clientY: e.touches[0].clientY
                });
            }
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            stopDrag();
        }
        
        function openImageViewer(imageSrc) {
            imageViewerImg.src = imageSrc;
            imageViewer.style.display = 'flex';
            resetImageViewer();
        }
        
        function zoomImageViewer(factor, centerX, centerY) {
            const oldScale = imageViewerScale;
            imageViewerScale *= factor;
            
            // Limites de zoom
            if (imageViewerScale < 0.1) imageViewerScale = 0.1;
            if (imageViewerScale > 5) imageViewerScale = 5;
            
            if (centerX !== undefined && centerY !== undefined) {
                if (!imageViewerRect) {
                    imageViewerRect = imageViewer.getBoundingClientRect();
                }
                const relativeX = centerX - imageViewerRect.left;
                const relativeY = centerY - imageViewerRect.top;
                
                imageViewerTranslateX = relativeX - (relativeX - imageViewerTranslateX) * (imageViewerScale / oldScale);
                imageViewerTranslateY = relativeY - (relativeY - imageViewerTranslateY) * (imageViewerScale / oldScale);
            }
            
            updateImageViewerTransform();
        }
        
        function resetImageViewer() {
            imageViewerScale = 1;
            imageViewerTranslateX = 0;
            imageViewerTranslateY = 0;
            imageViewerRect = null;
            updateImageViewerTransform();
        }
        
        function updateImageViewerTransform() {
            imageViewerImg.style.transform = `translate(${imageViewerTranslateX}px, ${imageViewerTranslateY}px) scale(${imageViewerScale})`;
            imageViewerZoomInfo.textContent = `${Math.round(imageViewerScale * 100)}%`;
        }
        
        function startDrag(e) {
            isDragging = true;
            dragStartX = e.clientX - imageViewerTranslateX;
            dragStartY = e.clientY - imageViewerTranslateY;
            imageViewerImg.style.cursor = 'grabbing';
        }
        
        function doDrag(e) {
            if (!isDragging) return;
            
            imageViewerTranslateX = e.clientX - dragStartX;
            imageViewerTranslateY = e.clientY - dragStartY;
            
            if (!imageViewerRect) {
                imageViewerRect = imageViewer.getBoundingClientRect();
            }
            
            if (imageViewerScale > 1) {
                const imgRect = imageViewerImg.getBoundingClientRect();
                const maxX = Math.max(0, (imgRect.width * imageViewerScale - imageViewerRect.width) / 2);
                const maxY = Math.max(0, (imgRect.height * imageViewerScale - imageViewerRect.height) / 2);
                
                imageViewerTranslateX = Math.max(-maxX, Math.min(maxX, imageViewerTranslateX));
                imageViewerTranslateY = Math.max(-maxY, Math.min(maxY, imageViewerTranslateY));
            }
            
            updateImageViewerTransform();
        }
        
        function stopDrag() {
            isDragging = false;
            imageViewerImg.style.cursor = 'grab';
        }

        async function checkAdminAuth() {
            try {
                const adminSession = localStorage.getItem('adminSession');
                if (!adminSession) {
                    redirectToLogin();
                    return;
                }
                
                const sessionData = JSON.parse(adminSession);
                adminUser = sessionData;
                
                // Verificação de autenticação otimizada
                try {
                    const user = auth.currentUser;
                    if (user && user.email !== adminUser.email) {
                        adminUser = {
                            uid: user.uid,
                            email: user.email,
                            name: user.displayName || user.email.split('@')[0],
                            photoURL: user.photoURL,
                            loggedIn: true,
                            timestamp: now()
                        };
                        localStorage.setItem('adminSession', JSON.stringify(adminUser));
                    }
                } catch (authError) {
                    console.log('Auth check skipped:', authError);
                }
                
            } catch (error) {
                console.error('Admin auth error:', error);
                localStorage.removeItem('adminSession');
                redirectToLogin();
            }
        }

        function redirectToLogin() {
            showNotification('Acesso não autorizado. Redirecionando para login...', 'error');
            setTimeout(() => { window.location.href = 'login.html'; }, 1500);
        }

        function updateAdminInfo() {
            if (!adminUser) return;
            
            adminInfo.innerHTML = `
                <div class="flex items-center gap-2">
                    ${adminUser.photoURL ? 
                        `<img src="${adminUser.photoURL}" alt="${adminUser.name}" style="width: 24px; height: 24px; border-radius: 50%;">` : 
                        `<i class="fas fa-user" style="color: #757575;"></i>`
                    }
                    <div>
                        <div style="font-weight: 600;">${adminUser.name || 'Administrador'}</div>
                        <div style="font-size: 0.8rem; color: #757575;">${adminUser.email}</div>
                    </div>
                </div>
            `;
        }

        function updateLastUpdateTime() {
            lastUpdateTime = new Date();
            lastUpdate.textContent = lastUpdateTime.toLocaleTimeString('pt-BR');
        }

        async function loadSystemConfig() {
            try {
                const configDoc = await db.collection('configuracao').doc('pagamento').get();
                if (configDoc.exists) {
                    systemConfig = configDoc.data();
                    updateSettingsForm();
                } else {
                    systemConfig = {
                        pixKey: 'chave-pix@empresa.com',
                        adminWhatsApp: '(11) 99999-9999',
                        monthlyPlanPrice: 99.00,
                        expirationWarningDays: 7,
                        updatedAt: now()
                    };
                    await db.collection('configuracao').doc('pagamento').set(systemConfig);
                    updateSettingsForm();
                }
            } catch (error) {
                console.error('Error loading system config:', error);
                showNotification('Ajustes carregadas com padrões.', 'info');
            }
        }

        function updateSettingsForm() {
            if (!systemConfig) return;
            pixKeyInput.value = systemConfig.pixKey || '';
            adminWhatsAppInput.value = systemConfig.adminWhatsApp || '';
            monthlyPlanPriceInput.value = systemConfig.monthlyPlanPrice || 99.00;
            expirationWarningDaysInput.value = systemConfig.expirationWarningDays || 7;
        }

        async function loadAllUsers() {
            try {
                showLoading();
                const snapshot = await db.collection('lojas').get();
                
                users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordenação otimizada
                users.sort((a, b) => {
                    const dateA = a.createdAt || a.timestamp || '';
                    const dateB = b.createdAt || b.timestamp || '';
                    return dateB.localeCompare(dateA);
                });
                
                updateUsersList();
                updateStats();
                updateLastUpdateTime();
                hideLoading();
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Erro ao carregar usuários.', 'error');
                hideLoading();
            }
        }

        async function loadAllPayments() {
            try {
                const snapshot = await db.collection('pagamentos').orderBy('createdAt', 'desc').get();
                
                payments = [];
                snapshot.forEach(doc => {
                    payments.push({ id: doc.id, ...doc.data() });
                });
                
                updatePaymentsList();
                updateLastUpdateTime();
            } catch (error) {
                console.error('Error loading payments:', error);
                showNotification('Erro ao carregar pagamentos.', 'error');
            }
        }

        function updateStats() {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active').length;
            const pendingUsers = users.filter(user => user.status === 'pending').length;
            const blockedUsers = users.filter(user => user.status === 'blocked').length;
            const expiredUsers = users.filter(user => user.status === 'expired').length;
            const renewalPendingUsers = users.filter(user => user.renewalStatus === 'pending').length;
            
            const stats = [
                { icon: 'users', label: 'Total', value: totalUsers, color: 'total' },
                { icon: 'check-circle', label: 'Ativos', value: activeUsers, color: 'active' },
                { icon: 'clock', label: 'Pendentes', value: pendingUsers, color: 'pending' },
                { icon: 'ban', label: 'Bloqueados', value: blockedUsers, color: 'blocked' },
                { icon: 'calendar-times', label: 'Expirados', value: expiredUsers, color: 'expired' },
                { icon: 'sync-alt', label: 'Renovações Pendentes', value: renewalPendingUsers, color: 'revenue' }
            ];
            
            statsGrid.innerHTML = '';
            
            // Uso de DocumentFragment para menor reflow
            const fragment = document.createDocumentFragment();
            stats.forEach(stat => {
                const statCard = createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = templates.statCard(stat);
                fragment.appendChild(statCard);
            });
            statsGrid.appendChild(fragment);
        }

        function updateUsersList() {
            // Limpeza eficiente
            usersList.textContent = '';
            
            if (users.length === 0) {
                usersEmpty.style.display = 'block';
                return;
            }
            
            usersEmpty.style.display = 'none';
            const searchTerm = searchUsers.value.toLowerCase();
            
            const fragment = document.createDocumentFragment();
            const searchLower = searchTerm.toLowerCase();
            
            for (const user of users) {
                if (searchTerm && !user.storeName?.toLowerCase().includes(searchLower) && !user.email?.toLowerCase().includes(searchLower)) continue;
                
                let status = user.status || 'pending';
                const renewalStatus = user.renewalStatus || 'none';
                if (renewalStatus === 'pending' || renewalStatus === 'pending_approval') status = 'renewal_pending';
                
                const statusText = getStatusText(status, renewalStatus);
                const statusClass = getStatusClass(status, renewalStatus);
                
                const userItem = createElement('div');
                userItem.className = 'list-item';
                userItem.setAttribute('data-user-id', user.id);
                userItem.innerHTML = `
                    <div class="item-header">
                        <div>
                            <div class="item-title">${escapeHtml(user.storeName || 'Sem nome')}</div>
                            <div class="item-subtitle">${escapeHtml(user.email)}</div>
                            <div class="item-subtitle">${escapeHtml(user.phone || 'Não informado')}</div>
                            ${renewalStatus === 'pending' || renewalStatus === 'pending_approval' ? 
                                `<div class="item-subtitle" style="color: var(--info-color); font-weight: 500;"><i class="fas fa-sync-alt"></i> Renovação pendente</div>` : ''
                            }
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="item-details">
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span class="detail-value">${statusText}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Expira em</span>
                            <span class="detail-value">${escapeHtml(user.expiryDate || 'Não definida')}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Plano</span>
                            <span class="detail-value">${getPlanText(user.plan)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Cadastro</span>
                            <span class="detail-value">${formatDate(user.createdAt)}</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn btn-view" data-id="${user.id}" data-action="view"><i class="fas fa-eye"></i> Ver</button>
                        ${status === 'active' || status === 'renewal_pending' ? `
                            <button class="action-btn btn-block" data-id="${user.id}" data-action="block"><i class="fas fa-ban"></i> Bloquear</button>
                        ` : `
                            <button class="action-btn btn-activate" data-id="${user.id}" data-action="activate"><i class="fas fa-check"></i> Ativar</button>
                        `}
                    </div>
                `;
                
                fragment.appendChild(userItem);
            }
            
            usersList.appendChild(fragment);
            
            // Event delegation otimizada
            usersList.addEventListener('click', handleUserListClick);
        }

        function handleUserListClick(e) {
            const target = e.target;
            const actionBtn = target.closest('.action-btn');
            
            if (!actionBtn) {
                const listItem = target.closest('.list-item');
                if (listItem) {
                    const userId = listItem.getAttribute('data-user-id');
                    viewUserDetails(userId);
                }
                return;
            }
            
            e.stopPropagation();
            const id = actionBtn.getAttribute('data-id');
            const action = actionBtn.getAttribute('data-action');
            
            if (action === 'view') {
                viewUserDetails(id);
            } else if (action === 'block') {
                toggleUserStatus(id, 'blocked');
            } else if (action === 'activate') {
                toggleUserStatus(id, 'active');
            }
        }

        function updatePaymentsList() {
            paymentsList.textContent = '';
            
            if (payments.length === 0) {
                paymentsEmpty.style.display = 'block';
                return;
            }
            
            paymentsEmpty.style.display = 'none';
            const searchTerm = searchPayments.value.toLowerCase();
            
            const fragment = document.createDocumentFragment();
            const searchLower = searchTerm.toLowerCase();
            
            for (const payment of payments) {
                if (searchTerm && 
                    !payment.userName?.toLowerCase().includes(searchLower) && 
                    !payment.storeName?.toLowerCase().includes(searchLower) && 
                    !payment.userEmail?.toLowerCase().includes(searchLower)) continue;
                
                const status = payment.status || 'pending';
                const statusText = getPaymentStatusText(status);
                const statusClass = getPaymentStatusClass(status);
                const paymentType = payment.type === 'renewal' ? '🔄 Renovação' : '📋 Novo';
                
                const paymentItem = createElement('div');
                paymentItem.className = 'list-item';
                paymentItem.setAttribute('data-payment-id', payment.id);
                paymentItem.innerHTML = `
                    <div class="item-header">
                        <div>
                            <div class="item-title">${escapeHtml(payment.userName || 'Nome não informado')} ${paymentType}</div>
                            <div class="item-subtitle">${escapeHtml(payment.storeName || 'Sem nome')}</div>
                            <div class="item-subtitle">${escapeHtml(payment.userEmail)}</div>
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="item-details">
                        <div class="detail-item"><span class="detail-label">Tipo</span><span class="detail-value">${paymentType}</span></div>
                        <div class="detail-item"><span class="detail-label">Valor</span><span class="detail-value">R$ ${(payment.amount?.toFixed(2) || '0,00').replace('.', ',')}</span></div>
                        <div class="detail-item"><span class="detail-label">Data</span><span class="detail-value">${formatDate(payment.createdAt)}</span></div>
                        <div class="detail-item"><span class="detail-label">Telefone</span><span class="detail-value">${escapeHtml(payment.userPhone || 'Não informado')}</span></div>
                    </div>
                    <div class="action-buttons" style="justify-content: space-evenly; padding-top: 12px; border-top: 1px solid var(--border-color);">
                        ${status === 'pending' || status === 'pending_approval' ? `
                            <button class="icon-action-btn approve" title="Aprovar pagamento" data-id="${payment.id}" data-action="finish">
                                <svg viewBox="0 0 24 24">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                </svg>
                            </button>
                            <button class="icon-action-btn reject" title="Rejeitar pagamento" data-id="${payment.id}" data-action="reject">
                                <svg viewBox="0 0 24 24">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                            </button>
                        ` : `
                            <button class="icon-action-btn view" title="Ver detalhes" data-id="${payment.id}" data-action="view">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                            </button>
                            <button class="icon-action-btn delete" title="Excluir pagamento" data-id="${payment.id}" data-action="delete">
                                <svg viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        `}
                    </div>
                `;
                
                fragment.appendChild(paymentItem);
            }
            
            paymentsList.appendChild(fragment);
            
            // Event delegation otimizada
            paymentsList.addEventListener('click', handlePaymentListClick);
        }

        function handlePaymentListClick(e) {
            const target = e.target;
            const iconBtn = target.closest('.icon-action-btn');
            
            if (!iconBtn) {
                const listItem = target.closest('.list-item');
                if (listItem) {
                    const paymentId = listItem.getAttribute('data-payment-id');
                    viewPaymentDetails(paymentId);
                }
                return;
            }
            
            e.stopPropagation();
            const action = iconBtn.getAttribute('data-action');
            const id = iconBtn.getAttribute('data-id');
            
            switch(action) {
                case 'view':
                    viewPaymentDetails(id);
                    break;
                case 'finish':
                    finishPayment(id);
                    break;
                case 'reject':
                    rejectPayment(id);
                    break;
                case 'delete':
                    showDeleteConfirmation(id);
                    break;
            }
        }

        function setupEventListeners() {
            // Botão de refresh minimalista no cabeçalho
            refreshBtnMinimal.addEventListener('click', async () => {
                refreshBtnMinimal.style.transform = 'rotate(180deg)';
                await Promise.all([loadAllUsers(), loadAllPayments()]);
                showNotification('Dados atualizados!', 'success');
                setTimeout(() => {
                    refreshBtnMinimal.style.transform = 'rotate(0deg)';
                }, 300);
            });
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => { switchTab(btn.getAttribute('data-tab')); });
            });
            
            searchUsers.addEventListener('input', updateUsersList);
            searchPayments.addEventListener('input', updatePaymentsList);
            
            paymentSettingsForm.addEventListener('submit', saveSystemConfig);
            logoutBtn.addEventListener('click', logout);
            sendResetPasswordBtn.addEventListener('click', sendResetPasswordEmail);
            
            closeUserModal.addEventListener('click', () => userDetailsModal.style.display = 'none');
            closePaymentModal.addEventListener('click', () => paymentDetailsModal.style.display = 'none');
            closeDeleteModal.addEventListener('click', closeDeleteModalHandler);
            cancelDeleteBtn.addEventListener('click', closeDeleteModalHandler);
            
            // Event delegation para modais
            window.addEventListener('click', (e) => {
                if (e.target === userDetailsModal) userDetailsModal.style.display = 'none';
                if (e.target === paymentDetailsModal) paymentDetailsModal.style.display = 'none';
                if (e.target === deleteConfirmationModal) closeDeleteModalHandler();
                if (e.target === imageViewer) imageViewer.style.display = 'none';
            });
            
            confirmationInput.addEventListener('input', function() {
                confirmDeleteBtn.disabled = this.value !== 'CONFIRMAR';
            });
            
            confirmDeleteBtn.addEventListener('click', deletePayment);
            
            if (adminWhatsAppInput) {
                new IMask(adminWhatsAppInput, { 
                    mask: '(00) 00000-0000', 
                    lazy: false 
                });
            }
        }

        async function logout() {
            try {
                showLoading();
                showNotification('Encerrando sessão...', 'info');
                
                // Limpar todos os dados da sessão
                localStorage.removeItem('adminSession');
                sessionStorage.clear();
                
                // Sair do Firebase Auth
                if (auth.currentUser) {
                    await auth.signOut();
                }
                
                // Limpar cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                // Forçar recarregamento completo da página de login
                setTimeout(() => {
                    window.location.href = 'login.html';
                    // Forçar navegador a não usar cache
                    window.location.replace('login.html?t=' + new Date().getTime());
                }, 1000);
                
            } catch (error) {
                console.error('Error during logout:', error);
                // Mesmo com erro, redirecionar para login
                localStorage.removeItem('adminSession');
                window.location.href = 'login.html';
            }
        }

        function closeDeleteModalHandler() {
            deleteConfirmationModal.style.display = 'none';
            resetDeleteConfirmation();
        }

        function resetDeleteConfirmation() {
            confirmationInput.value = '';
            confirmDeleteBtn.disabled = true;
            currentPaymentToDelete = null;
        }

        function switchTab(tabId) {
            tabBtns.forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId));
            tabContents.forEach(content => content.classList.toggle('active', content.id === `${tabId}Tab`));
        }

        async function sendResetPasswordEmail() {
            try {
                showLoading();
                const user = auth.currentUser;
                
                if (!user || !user.email) {
                    throw new Error('Nenhum usuário autenticado encontrado');
                }
                
                await auth.sendPasswordResetEmail(user.email);
                
                showNotification(`Link de redefinição enviado para ${user.email}. Verifique sua caixa de entrada.`, 'success');
                hideLoading();
            } catch (error) {
                console.error('Error sending reset password email:', error);
                let errorMessage = 'Erro ao enviar link de redefinição.';
                if (error.code === 'auth/user-not-found') errorMessage = 'Usuário não encontrado.';
                else if (error.code === 'auth/invalid-email') errorMessage = 'E-mail inválido.';
                else if (error.code === 'auth/too-many-requests') errorMessage = 'Muitas tentativas. Tente novamente mais tarde.';
                showNotification(errorMessage, 'error');
                hideLoading();
            }
        }

        async function viewUserDetails(userId) {
            const user = users.find(user => user.id === userId);
            if (!user) return;
            
            let status = user.status || 'pending';
            const renewalStatus = user.renewalStatus || 'none';
            if (renewalStatus === 'pending' || renewalStatus === 'pending_approval') status = 'renewal_pending';
            
            const statusText = getStatusText(status, renewalStatus);
            const statusClass = getStatusClass(status, renewalStatus);
            
            let renewalInfo = '';
            if (renewalStatus === 'pending' || renewalStatus === 'pending_approval') {
                const pendingPayment = payments.find(p => p.userId === userId && (p.status === 'pending' || p.status === 'pending_approval') && p.type === 'renewal');
                if (pendingPayment) {
                    renewalInfo = `
                        <div class="form-group">
                            <label class="form-label" style="color: var(--info-color);"><i class="fas fa-sync-alt"></i> Renovação Pendente</label>
                            <div class="form-input" style="background: #e8f4fd; border-left: 4px solid var(--info-color);">
                                <div><strong>Valor:</strong> R$ ${(pendingPayment.amount?.toFixed(2) || '0,00').replace('.', ',')}</div>
                                <div><strong>Data do pedido:</strong> ${formatDateTime(pendingPayment.createdAt)}</div>
                                <div><strong>Status:</strong> ${getPaymentStatusText(pendingPayment.status)}</div>
                                ${pendingPayment.notes ? `<div><strong>Observações:</strong> ${escapeHtml(pendingPayment.notes)}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            const content = `
                <div class="settings-section" style="border: none; padding: 0; box-shadow: none;">
                    ${renewalInfo}
                    <div class="form-group"><label class="form-label">Nome da Loja</label><div class="form-input" style="background: #f8f9fa;">${escapeHtml(user.storeName || 'Sem nome')}</div></div>
                    <div class="form-group"><label class="form-label">E-mail</label><div class="form-input" style="background: #f8f9fa;">${escapeHtml(user.email)}</div></div>
                    <div class="form-group"><label class="form-label">Telefone</label><div class="form-input" style="background: #f8f9fa;">${escapeHtml(user.phone || 'Não informado')}</div></div>
                    <div class="form-group"><label class="form-label">Status</label><div class="form-input" style="background: #f8f9fa;"><span class="status-badge ${statusClass}">${statusText}</span></div></div>
                    <div class="form-group"><label class="form-label">Data de Cadastro</label><div class="form-input" style="background: #f8f9fa;">${formatDateTime(user.createdAt)}</div></div>
                    <div class="form-group"><label class="form-label">Expira em</label><div class="form-input" style="background: #f8f9fa;">${escapeHtml(user.expiryDate || 'Não definida')}</div></div>
                    <div class="form-group"><label class="form-label">Plano</label><div class="form-input" style="background: #f8f9fa;">${getPlanText(user.plan)}</div></div>
                    <div class="form-group"><label class="form-label">Status de Renovação</label><div class="form-input" style="background: #f8f9fa;">
                        ${renewalStatus === 'none' ? 'Nenhuma renovação pendente' : 
                          renewalStatus === 'pending' ? 'Renovação solicitada' :
                          renewalStatus === 'pending_approval' ? 'Aguardando aprovação' :
                          renewalStatus === 'approved' ? 'Renovação aprovada' :
                          renewalStatus === 'rejected' ? 'Renovação rejeitada' : renewalStatus}
                    </div></div>
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="submit-btn" style="background: #757575;" id="closeDetailsBtn">Fechar</button>
                        ${status === 'active' || status === 'renewal_pending' ? `
                            <button type="button" class="submit-btn" style="background: var(--danger-color);" id="blockUserBtn"><i class="fas fa-ban"></i> Bloquear</button>
                        ` : `
                            <button type="button" class="submit-btn" style="background: var(--success-color);" id="activateUserBtn"><i class="fas fa-check"></i> Ativar</button>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('userDetailsContent').innerHTML = content;
            document.getElementById('closeDetailsBtn')?.addEventListener('click', () => userDetailsModal.style.display = 'none');
            document.getElementById('blockUserBtn')?.addEventListener('click', () => { userDetailsModal.style.display = 'none'; toggleUserStatus(userId, 'blocked'); });
            document.getElementById('activateUserBtn')?.addEventListener('click', () => { userDetailsModal.style.display = 'none'; toggleUserStatus(userId, 'active'); });
            userDetailsModal.style.display = 'flex';
        }

        async function toggleUserStatus(userId, newStatus) {
            try {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                const statusText = getStatusText(newStatus);
                let updateData = { status: newStatus, updatedAt: now() };
                
                if (newStatus === 'active') {
                    let planDays = 30;
                    if (user.plan === 'custom' && user.planDays) planDays = parseInt(user.planDays) || 30;
                    
                    const date = new Date();
                    date.setDate(date.getDate() + planDays);
                    updateData.expiryDate = date.toISOString().split('T')[0];
                    updateData.isActive = true;
                } else if (newStatus === 'blocked') {
                    updateData.isActive = false;
                    updateData.renewalStatus = 'none';
                    
                    // Otimização: processamento em lote
                    const pendingRenewals = payments.filter(p => p.userId === userId && p.type === 'renewal' && (p.status === 'pending' || p.status === 'pending_approval'));
                    const batch = db.batch();
                    const paymentRefs = pendingRenewals.map(p => db.collection('pagamentos').doc(p.id));
                    
                    paymentRefs.forEach(ref => {
                        batch.update(ref, {
                            status: 'rejected',
                            rejectedAt: now(),
                            rejectedBy: adminUser.email,
                            rejectionReason: 'Usuário bloqueado'
                        });
                    });
                    
                    if (paymentRefs.length > 0) {
                        await batch.commit();
                    }
                }
                
                await db.collection('lojas').doc(userId).update(updateData);
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    Object.assign(users[userIndex], updateData);
                }
                
                await loadAllPayments();
                updateUsersList();
                updateStats();
                showNotification(`Usuário ${statusText.toLowerCase()}!`, 'success');
            } catch (error) {
                console.error('Error updating user status:', error);
                showNotification('Erro ao atualizar status.', 'error');
            }
        }

        function viewPaymentDetails(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const statusText = getPaymentStatusText(payment.status);
            const statusClass = getPaymentStatusClass(payment.status);
            const paymentType = payment.type === 'renewal' ? 'Renovação de Plano' : 'Novo Cadastro';
            
            let receiptContent = '';
            if (payment.receiptBase64) {
                if (payment.receiptType === 'pdf') {
                    receiptContent = `<div class="form-group"><label class="form-label">Comprovante</label><button class="submit-btn" onclick="downloadReceipt('${payment.id}')" style="background: var(--danger-color);"><i class="fas fa-file-pdf"></i> Baixar Comprovante PDF</button></div>`;
                } else {
                    receiptContent = `<div class="form-group"><label class="form-label">Comprovante <span style="color: var(--info-color); font-size: 0.8rem;">(clique para ampliar)</span></label><div class="receipt-preview-container"><img src="${payment.receiptBase64}" alt="Comprovante" class="receipt-preview-img" onclick="openImageViewer('${payment.receiptBase64}')" style="cursor: pointer;"></div></div>`;
                }
            } else {
                receiptContent = `<div class="form-group"><label class="form-label">Comprovante</label><div class="form-input" style="background: #f8f9fa; text-align: center; color: var(--text-secondary);"><i class="fas fa-file-image" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>Sem comprovante anexado</div></div>`;
            }
            
            let renewalInfo = '';
            if (payment.type === 'renewal') {
                renewalInfo = `
                    <div class="form-group">
                        <label class="form-label">Informações da Renovação</label>
                        <div class="form-input" style="background: #f0f9ff; border-left: 4px solid var(--info-color);">
                            <div><strong>Data de vencimento original:</strong> ${formatDate(payment.originalExpiryDate)}</div>
                            <div><strong>Nova data de vencimento:</strong> ${formatDate(payment.newExpiryDate)}</div>
                            ${payment.notes ? `<div><strong>Observações:</strong> ${escapeHtml(payment.notes)}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            const content = `
                <div class="settings-section" style="border: none; padding: 0; box-shadow: none;">
                    <div class="form-group"><label class="form-label">Tipo de Pagamento</label><div class="form-input" style="background: #f8f9fa; font-weight: 600;">${paymentType}</div></div>
                    ${renewalInfo}
                    <div class="form-group"><label class="form-label">Cliente</label><div class="form-input" style="background: #f8f9fa;">${escapeHtml(payment.userName || 'Nome não informado')}</div></div>
                    <div class="form-group"><label class="form-label">Loja</label><div class="form-input" style="background: #f8f9fa;">${escapeHtml(payment.storeName || 'Sem nome')}</div></div>
                    <div class="form-group"><label class="form-label">E-mail</label><div class="form-input" style="background: #f8f9fa;">${escapeHtml(payment.userEmail)}</div></div>
                    <div class="form-group"><label class="form-label">Telefone</label><div class="form-input" style="background: #f8f9fa;">${escapeHtml(payment.userPhone || 'Não informado')}</div></div>
                    <div class="form-group"><label class="form-label">Status</label><div class="form-input" style="background: #f8f9fa;"><span class="status-badge ${statusClass}">${statusText}</span></div></div>
                    <div class="form-group"><label class="form-label">Plano</label><div class="form-input" style="background: #f8f9fa;">${payment.plan === 'monthly' ? 'Mensal' : 'Personalizado'}</div></div>
                    <div class="form-group"><label class="form-label">Valor</label><div class="form-input" style="background: #f8f9fa;">R$ ${(payment.amount?.toFixed(2) || '0,00').replace('.', ',')}</div></div>
                    <div class="form-group"><label class="form-label">Data</label><div class="form-input" style="background: #f8f9fa;">${formatDateTime(payment.createdAt)}</div></div>
                    ${payment.approvedAt ? `<div class="form-group"><label class="form-label">Aprovado em</label><div class="form-input" style="background: #f8f9fa;">${formatDateTime(payment.approvedAt)}</div></div>` : ''}
                    ${payment.rejectedAt ? `<div class="form-group"><label class="form-label">Rejeitado em</label><div class="form-input" style="background: #f8f9fa;">${formatDateTime(payment.rejectedAt)}</div></div>${payment.rejectionReason ? `<div class="form-group"><label class="form-label">Motivo da rejeição</label><div class="form-input" style="background: #f8f9fa;">${escapeHtml(payment.rejectionReason)}</div></div>` : ''}` : ''}
                    ${receiptContent}
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="submit-btn" style="background: #757575;" id="closePaymentBtn">Fechar</button>
                    </div>
                </div>
            `;
            
            document.getElementById('paymentDetailsContent').innerHTML = content;
            document.getElementById('closePaymentBtn')?.addEventListener('click', () => paymentDetailsModal.style.display = 'none');
            window.downloadReceipt = function(id) {
                const p = payments.find(p => p.id === id);
                if (p && p.receiptBase64) {
                    const link = document.createElement('a');
                    link.href = p.receiptBase64;
                    link.download = p.receiptFileName || 'comprovante.pdf';
                    link.click();
                }
            };
            paymentDetailsModal.style.display = 'flex';
        }

        async function finishPayment(paymentId) {
            try {
                const payment = payments.find(p => p.id === paymentId);
                if (!payment) return;
                
                const userId = payment.userId;
                const user = users.find(u => u.id === userId);
                let newExpiryDate = new Date();
                let planDays = 30;
                
                if (payment.plan === 'custom' && payment.planDays) planDays = parseInt(payment.planDays) || 30;
                if (payment.type === 'renewal' && user && user.expiryDate) {
                    const currentExpiry = new Date(user.expiryDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    if (currentExpiry > today) newExpiryDate = new Date(currentExpiry);
                }
                
                newExpiryDate.setDate(newExpiryDate.getDate() + planDays);
                const expiryDateStr = newExpiryDate.toISOString().split('T')[0];
                
                await db.collection('pagamentos').doc(paymentId).update({
                    status: 'approved',
                    approvedAt: now(),
                    approvedBy: adminUser.email,
                    newExpiryDate: expiryDateStr
                });
                
                const updateData = {
                    status: 'active',
                    isActive: true,
                    expiryDate: expiryDateStr,
                    renewalStatus: 'approved',
                    lastRenewalDate: now(),
                    paymentConfirmed: true,
                    lastPaymentDate: now()
                };
                
                if (payment.type !== 'renewal') {
                    updateData.plan = payment.plan || 'monthly';
                    updateData.planDays = payment.planDays || 30;
                }
                
                await db.collection('lojas').doc(userId).update(updateData);
                showNotification('Pagamento concluído! Usuário ativado.', 'success');
                await Promise.all([loadAllUsers(), loadAllPayments()]);
            } catch (error) {
                console.error('Error finishing payment:', error);
                showNotification('Erro ao concluir pagamento.', 'error');
            }
        }

        async function rejectPayment(paymentId) {
            try {
                const payment = payments.find(p => p.id === paymentId);
                if (!payment) return;
                
                const rejectionReason = prompt('Digite o motivo da rejeição:');
                if (!rejectionReason) { 
                    showNotification('Operação cancelada. Motivo não informado.', 'warning'); 
                    return; 
                }
                
                await db.collection('pagamentos').doc(paymentId).update({
                    status: 'rejected',
                    rejectedAt: now(),
                    rejectedBy: adminUser.email,
                    rejectionReason: rejectionReason
                });
                
                if (payment.type === 'renewal') {
                    await db.collection('lojas').doc(payment.userId).update({
                        renewalStatus: 'rejected',
                        lastRenewalResponse: now()
                    });
                }
                
                showNotification('Pagamento rejeitado!', 'warning');
                await Promise.all([loadAllPayments(), loadAllUsers()]);
            } catch (error) {
                console.error('Error rejecting payment:', error);
                showNotification('Erro ao rejeitar pagamento.', 'error');
            }
        }

        function showDeleteConfirmation(paymentId) {
            currentPaymentToDelete = paymentId;
            deleteConfirmationModal.style.display = 'flex';
            setTimeout(() => { confirmationInput.focus(); }, 300);
        }

        async function deletePayment() {
            if (!currentPaymentToDelete) return;
            
            try {
                await db.collection('pagamentos').doc(currentPaymentToDelete).delete();
                const paymentIndex = payments.findIndex(p => p.id === currentPaymentToDelete);
                if (paymentIndex !== -1) payments.splice(paymentIndex, 1);
                deleteConfirmationModal.style.display = 'none';
                resetDeleteConfirmation();
                updatePaymentsList();
                showNotification('Pagamento excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Error deleting payment:', error);
                showNotification('Erro ao excluir pagamento.', 'error');
            }
        }

        async function saveSystemConfig(e) {
            e.preventDefault();
            
            const configData = {
                pixKey: pixKeyInput.value,
                adminWhatsApp: adminWhatsAppInput.value,
                monthlyPlanPrice: parseFloat(monthlyPlanPriceInput.value) || 99.00,
                expirationWarningDays: parseInt(expirationWarningDaysInput.value) || 7,
                updatedAt: now(),
                updatedBy: adminUser.email
            };
            
            try {
                await db.collection('configuracao').doc('pagamento').set(configData, { merge: true });
                systemConfig = configData;
                showNotification('Ajustes salvas!', 'success');
            } catch (error) {
                console.error('Error saving system config:', error);
                showNotification('Erro ao salvar Ajustes.', 'error');
            }
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease';
                setTimeout(() => { 
                    if (notification.parentNode) {
                        document.body.removeChild(notification); 
                    }
                }, 300);
            }, duration);
        }

        function showLoading() { loadingOverlay.style.display = 'flex'; }
        function hideLoading() { loadingOverlay.style.display = 'none'; }
        
        // Funções utilitárias otimizadas
        function formatDate(dateString) {
            if (!dateString) return 'Data não informada';
            try { 
                return new Date(dateString).toLocaleDateString('pt-BR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }); 
            } catch (error) { return 'Data inválida'; }
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'Data/hora não informada';
            try { 
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }) + ' ' + date.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                }); 
            } catch (error) { return 'Data inválida'; }
        }
        
        function getStatusText(status, renewalStatus = 'none') {
            if (status === 'renewal_pending') {
                return renewalStatus === 'pending_approval' ? 'Aguardando Aprovação' : 'Renovação Pendente';
            }
            return STATUS_TEXTS[status] || 'Desconhecido';
        }
        
        function getStatusClass(status, renewalStatus = 'none') {
            if (status === 'renewal_pending') return 'status-renewal-pending';
            return STATUS_CLASSES[status] || 'status-pending';
        }
        
        function getPlanText(plan) {
            return plan === 'monthly' ? 'Mensal (30 dias)' : 
                   plan === 'custom' ? 'Personalizado' : 'Mensal';
        }
        
        function getPaymentStatusText(status) {
            return PAYMENT_STATUS_TEXTS[status] || 'Desconhecido';
        }
        
        function getPaymentStatusClass(status) {
            return PAYMENT_STATUS_CLASSES[status] || 'status-pending';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>